## README

## Data Analysis of SMR files
**In progress**
The goal here is to prepare the files to feed to HVC for automatic labelling of songs.

#### Acknowledgements
- Eduarda Centeno
- Roman Ursu
- Arthur Leblois
- For HVC - automatic syllable labeller - The Sober Lab at Emory University [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.1475481.svg)](https://doi.org/10.5281/zenodo.1475481)

Python 3.7 is required, unless specified otherwise.
Update: Python 3.9 is required, due to SonPy package (used in CedIO).


#### Requirements
- HVCHackathon/Installation/requirements.txt
- HVCHackathon/Installation/hvcenv.yml

---

1. Given: An SMR or SMRX file. 

2. Specify the name of the song channel in the file ```parameters.json``` under keyword `songChannelName`.
2.1 Specify the rec system name in parameters.json. This will be important for the sampling frequency. Options: Neuralynx or Alpha_omega


3. Check if neo is able to read the file and extract the songfile in npy format.
    ```
    python get_song_from_smr.py <path>/<file_name>.smr
    ```  
    E.g. ```python get_song_from_smr.py ../SampleData/CSC1.smr```
    
4. Slice the songfile into smaller chunks (4 second chunks)
	```
	python Slicing_Songfile.py <path>/songfile_name.npy
	```  
	E.g. ```python Slicing_Songfile.py ../SampleData/CSC20_Songfile.npy```

5. Check the thresholds for syllable segmentation. 
	```
	python Auxilliary_support.py <path>/songfile_name.npy
	```  
	E.g. ```python Auxilliary_support.py ../SampleData/CSC20_Songfile.npy```
	
6. Modify the parameters in the file ```parameters.json``` to test new thresholds. Here you can use the vmin/vmax params in the parameters.json to improve the spectrogram contrast!

7. Remove the chunks that only contain silence. 
	```
	python Detect_syllables.py <path-to-parent-folder-of-Raw_songs>
	```  
	E.g. ```python Detect_syllables.py ../SampleData/```
	
8. Use an IDE which allows plots to be rendered outside the window (or the terminal), with a suitable backend, and annotate as many songs as required (~100). Vmin/Vmax can also be changed here!
	```
	python Manual_labeling.py <path-to-parent-folder-of-Clean_songs>
	```  
	E.g. ```python Manual_labeling.py ../SampleData/```


9. Use ```HVC``` to automatically label the rest of the syllables. (Detailed instructions in HVC folder.)





Optional:

1. Test the npy songfile generated by converting to wav and viewing in any audio software.
	```
	python conv_npy_to_wav.py ../SampleData/CSC20_Songfile.npy
	```

2. Alternatively, extract songfiles from all recording directories (follow template), and split them into chunks, as a batch.
	```
	python extractSongfile.sh ../SampleData/
	```

----

### Folder: Syllables_processing


#### Script: Slicing_Songfile.py

- This scripts extracts the song from the smr file and splits it into smaller chunks (txt), for ease in further processing.
- To run: `python Slicing_Songfile.py path_to_file.smr`.


#### Script: Auxilliary_support.py

- This scripts plots the song in an npy/txt file, in an interactive manner.
- Not meant to be a generic code for public use.
- Just an auxilliary file to quickly visualise the song and adjust the syllable segmenting parameters.
- Parameters should be adjusted per bird in the json file.
- Control the portion of the song file to be plotted, by using the json file.
- By default, only the first 30seconds of the file is displayed.
- To change the starting position, change 'start_pos' in terms of sample index.
- To change the duration to plot, change 'display_duration' in seconds.
- To plot the entire file, set start_pos as 0 and display_duration as any number longer than the file.
- To run: `python Auxilliary_support.py path_to_npy_file.npy` or `python Auxilliary_support.py path_to_txt_file.txt`.


#### Script: Detect_syllables.py

- Get files from `Raw_songs` folder.
- Detects if it has silence.
- If so, the file is moved to `Noise_songs` folder.
- Ensure the segmenting parameters are correct.
- To run: `python Detect_syllables.py path_to_parent_folder`

#### Script: Manual_labeling.py

- Give the path to the parent folder of `Raw_songs` as an argument when you run the python script: `python Manual_labeling.py parent_folder_name`.
- Ensure this folder has a folder called `Raw_songs` with the songfiles (.txt) to be labelled.
- Ensure this folder doesn't have a clashing `Annotations`, `Clean_songs` or `Noise_songs` folder (as some files will be moved/created in these folders).
- To change the threshold, etc parameters, you'll have to change the json parameters file.

---

#### Folder: HVC

- Folder with sample config files to run HVC syllable labeler.
- Path and segmenting parameteres in config files should be updated for each run.
- To run, move to HVC folder and:

`hvc.extract('Extract.yml')`

`hvc.select('Select.yml')`

`hvc.predict('Predict.yml')`

- Detailed explanation in `HVC` folder.

---
